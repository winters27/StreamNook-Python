name: Build and Release

# Quote "on" because YAML 1.1 treats bare "on" as boolean
"on":
  push:
    branches: [ "main" ]
  workflow_dispatch: {}   # allow manual runs

permissions:
  contents: write    # needed for creating releases/tags
  actions: read
  checks: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Windows EXE and create Release
    runs-on: windows-latest

    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tags available
        run: |
          git fetch --tags --force

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Install build deps and UPX
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          choco install upx --no-progress
          echo "UPX_DIR=C:\ProgramData\chocolatey\lib\upx\tools" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append


      - id: version
        name: Determine next version from tags and commits
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          # Get all tags and sort them
          $latestTag = (git tag --list "v*" --sort=-v:refname | Select-Object -First 1)
          if (-not $latestTag) { $latestTag = "v0.0.0" }

          # Get commits since last tag
          $commits = git log $latestTag..HEAD --oneline
          
          # If no new commits, skip the build
          if (-not $commits) {
              Write-Host "No new commits since $latestTag - skipping release"
              echo "SKIP_BUILD=true" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              exit 0
          }

          # Get commit messages for bump detection
          $commitMessages = git log $latestTag..HEAD --pretty=%B
          
          $bump = "patch" # Default
          if ($commitMessages -match 'BREAKING CHANGE' -or $commitMessages -match '## release: major') {
              $bump = "major"
          } elseif ($commitMessages -match '^feat' -or $commitMessages -match '## release: minor') {
              $bump = "minor"
          }

          if ($latestTag -match "^v(\d+)\.(\d+)\.(\d+)$") {
            $maj = [int]$Matches[1]; $min = [int]$Matches[2]; $pat = [int]$Matches[3]
          } else {
            $maj = 0; $min = 0; $pat = 0
          }

          switch ($bump) {
            "major" { $maj++; $min = 0; $pat = 0 }
            "minor" { $min++; $pat = 0 }
            default { $pat++ }
          }

          $next = "v{0}.{1}.{2}" -f $maj, $min, $pat
          
          # Check if this tag already exists (shouldn't happen, but safety check)
          $tagExists = git tag --list $next
          if ($tagExists) {
              Write-Host "Tag $next already exists - incrementing patch version"
              $pat++
              $next = "v{0}.{1}.{2}" -f $maj, $min, $pat
          }
          
          echo "NEXT_VERSION=$next" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "NEXT_VERSION_NO_V=$($next.TrimStart('v'))" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "version=$next" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Next version will be: $next"

      - name: Build application (PowerShell)
        if: env.SKIP_BUILD != 'true'
        shell: pwsh
        run: |
          ./build.ps1 -NonInteractive -VersionOverride $env:NEXT_VERSION_NO_V -UpxDir $env:UPX_DIR

      - name: Upload build as artifact (for debugging/retention)
        if: env.SKIP_BUILD != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: StreamNook-${{ env.NEXT_VERSION }}-exe
          path: ./dist/StreamNook.exe
          if-no-files-found: error
          retention-days: 14

      - id: notes
        name: Create release notes from commits
        if: env.SKIP_BUILD != 'true'
        shell: pwsh
        run: |
          $prev = (git tag --list "v*" --sort=-v:refname | Select-Object -First 1)
          if (-not $prev) { $prev = (git rev-list --max-parents=0 HEAD | Select-Object -First 1) }
          $lines = git log "$prev"..HEAD --pretty=format:"* %s (%h)"
          # escape for GitHub output (percent, LF, CR)
          $lines = $lines -replace '%','%25' -replace "`n","%0A" -replace "`r","%0D"
          echo "body=$lines" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Create tag
        if: env.SKIP_BUILD != 'true'
        shell: pwsh
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Double-check tag doesn't exist before creating
          $tagExists = git tag --list $env:NEXT_VERSION
          if ($tagExists) {
              Write-Error "Tag $env:NEXT_VERSION already exists!"
              exit 1
          }
          
          git tag $env:NEXT_VERSION
          git push origin $env:NEXT_VERSION

      # Create the GitHub Release and upload the EXE in one step
      - name: Publish GitHub Release
        if: env.SKIP_BUILD != 'true'
        uses: softprops/action-gh-release@v2
        with:
          name: StreamNook ${{ env.NEXT_VERSION }}
          tag_name: ${{ env.NEXT_VERSION }}
          body: |
            ### Changes
            ${{ steps.notes.outputs.body }}
          files: |
            ./dist/StreamNook.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}